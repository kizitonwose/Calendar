name: CI
on: [push, pull_request]
jobs:
    check:
        name: Check
        runs-on: ubuntu-latest
        timeout-minutes: 5
        steps:
            - uses: actions/checkout@v3
            - uses: gradle/wrapper-validation-action@v1
            - uses: actions/setup-java@v3
              with:
                  distribution: 'zulu'
                  java-version: 11

            - name: Check style
              run: ./gradlew ktlintCheck

    unit-tests:
        name: Unit tests
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - uses: actions/checkout@v3
            - uses: gradle/wrapper-validation-action@v1
            - uses: actions/setup-java@v3
              with:
                  distribution: 'zulu'
                  java-version: 11

            - name: Unit tests
              run: ./gradlew testDebugUnitTest

    instrumentation-tests:
        name: Instrumentation tests
        runs-on: macOS-latest
        timeout-minutes: 30
        strategy:
            fail-fast: true
            matrix:
                api-level: [24, 29, 33]
        steps:
            - uses: actions/checkout@v3
            - uses: gradle/wrapper-validation-action@v1
            - uses: actions/setup-java@v3
              with:
                  distribution: 'zulu'
                  java-version: 11

            # API 32+ emulators have no `default` system images.
            - name: Determine emulator target
              id: determine-target
              env:
                API_LEVEL: ${{ matrix.api-level }}
              run: |
                TARGET="default"
                if [ "$API_LEVEL" -ge "32" ]; then
                TARGET="google_apis"
                fi
                echo "::set-output name=TARGET::$TARGET"

            # API 30+ emulators only have x86_64 system images.
            - name: Determine emulator arch
              id: determine-arch
              env:
                API_LEVEL: ${{ matrix.api-level }}
              run: |
                ARCH="x86"
                if [ "$API_LEVEL" -ge "30" ]; then
                ARCH="x86_64"
                fi
                echo "::set-output name=ARCH::$ARCH"      

            - name: Instrumentation tests
              uses: reactivecircus/android-emulator-runner@v2
              with:
                  api-level: ${{ matrix.api-level }}
                  target: ${{ steps.determine-target.outputs.TARGET }}
                  arch: ${{ steps.determine-arch.outputs.ARCH }}
                  script: ./gradlew connectedDebugAndroidTest
